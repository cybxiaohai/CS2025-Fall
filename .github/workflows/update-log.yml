# .github/workflows/update-log.yml
name: Update Learning Log

on:
  schedule:
    - cron: "0 0 * * 1" # æ¯å‘¨ä¸€ 00:00 UTCï¼ˆåŒ—äº¬æ—¶é—´ å‘¨ä¸€ 8:00ï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      message:
        description: "è‡ªå®šä¹‰æ—¥å¿—å†…å®¹" # è¾“å…¥æ¡†æè¿°
        required: false
        default: "æœ¬å‘¨å­¦ä¹ ç»§ç»­ä¸­..."

jobs:
  update-log:
    name: ç”Ÿæˆå¹¶æ›´æ–°å­¦ä¹ æ—¥å¿—
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„Ubuntuç¯å¢ƒ

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          # å…è®¸æäº¤å˜æ›´
          token: ${{ secrets.ACCESS_TOKEN }}

      #æ·»åŠ ä¸€è¡Œæ–°æ—¥å¿—ï¼Œæ—¶é—´æ ¼å¼ä¸ºYYYY-MM-DD HH:MM
      - name: å‡†å¤‡æ—¥å¿—å†…å®¹
        id: prepare
        run: |
          #è·å–å½“å‰UTCæ—¶é—´å¹¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
          DATE=$(date "+%Y-%m-%d")
          DATETIME=$(date "+%Y-%m-%d %H:%M")

          #è·å–è¾“å…¥çš„æ¶ˆæ¯
          MESSAGE="${{ inputs.message }}"
          if [ -z "$MESSAGE" ]; then
            MESSAGE="æœ¬å‘¨å­¦ä¹ ç»§ç»­ä¸­..."
          fi

          LOG_FILE="docs/å­¦ä¹ æ—¥å¿—.md"

          # å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºåˆå§‹ç»“æ„
          if [ ! -f "$LOG_FILE" ]; then
            mkdir -p "$(dirname "$LOG_FILE")"
            cat > "$LOG_FILE"
          fi

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ç”¨äºå¤„ç†
          TEMP_FILE=$(mktemp)

          #æ ‡è®°æ˜¯å¦å·²æ’å…¥æ–°æ¡ç›®
          IEMP_FILE=false

          # è¯»å–åŸæ–‡ä»¶ï¼ŒæŒ‰è¡Œå¤„ç†
          while IFS= read -r line || [ -n "$line" ]; do
            # æ£€æµ‹æ ‡é¢˜è¡Œï¼ˆæ—¥æœŸæ ¼å¼ï¼‰
          if [[ $line =~ ^##[[:space:]]+[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              # æå–æ ‡é¢˜ä¸­çš„æ—¥æœŸ
              HEADER_DATE=$(echo "$line" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}')
              
              if [[ "$HEADER_DATE" == "$DATE" ]]; then
                # åŒä¸€å¤©ï¼šè¾“å‡ºæ ‡é¢˜ + æ–°æ¡ç›®
                echo "$line" >> "$TEMP_FILE"
                echo "- $DATETIME: $MESSAGE" >> "$TEMP_FILE"
                INSERTED=true
                # è·³è¿‡åç»­åŒç»„æ¡ç›®ï¼ˆé˜²æ­¢é‡å¤ï¼‰
                while IFS= read -r next_line && [[ "$next_line" =~ ^- ]]; do
                  echo "$next_line" >> "$TEMP_FILE"
                done
                # è¾“å‡ºä¸­æ–­çš„è¡Œï¼ˆéæ¡ç›®è¡Œï¼‰
                if [ -n "$next_line" ]; then
                  echo "$next_line" >> "$TEMP_FILE"
                fi
                continue
              elif [[ "$HEADER_DATE" < "$DATE" ]] && [[ "$INSERTED" == "false" ]]; then
                # æ–°æ—¥æœŸåº”æ’åœ¨æ­¤å‰ï¼ˆå€’åºï¼‰
                echo "## $DATE" >> "$TEMP_FILE"
                echo "- $DATETIME: $MESSAGE" >> "$TEMP_FILE"
                echo "" >> "$TEMP_FILE"
                INSERTED=true
              fi
            fi
            # é»˜è®¤ï¼šåŸæ ·è¾“å‡º
            echo "$line" >> "$TEMP_FILE"
          done < "$LOG_FILE"

          # å¦‚æœä»æœªæ’å…¥ï¼Œä¸”æ–‡ä»¶éç©º
          if [[ "$INSERTED" == "false" ]]; then
            echo "" >> "$TEMP_FILE"
            echo "## $DATE" >> "$TEMP_FILE"
            echo "- $DATETIME: $MESSAGE" >> "$TEMP_FILE"
          fi

          # æ›¿æ¢åŸæ–‡ä»¶
          mv "$TEMP_FILE" "$LOG_FILE"
          # æ·»åŠ æ–°æ—¥å¿—æ¡ç›®
          echo -e "\n## $DATE\n\n- [$DATETIME] $MESSAGE" >> "$LOG_ENTRY"

      - name: æäº¤æ›´æ”¹
        run: |
          git config --global user.name "cybxiaohai"
          git config --global user.email "icec41311@gmail.com"
          git add "$GITHUB_WORKSPACE/docs/å­¦ä¹ æ—¥å¿—.md"
          # æäº¤ï¼ˆé¿å…ç©ºæäº¤ï¼‰
          if git diff-index --quiet HEAD -- ; then
            echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–°å­¦ä¹ æ—¥å¿—: ${{ inputs.message }}"
            git remote set-url origin "https://cybxiaohai:${{ secrets.ACCESS_TOKEN }}@github.com/cybxiaohai/CS2025-Fall.git"
            git push origin HEAD:main
          fi
